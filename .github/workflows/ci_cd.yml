name: üß† Churn Engine - CI/CD Pipeline

on:
  push:
    branches: [main]
    paths:
      - "runners/**"
      - "top_three_models/**"
      - "utils/**"
      - "data/**"
  workflow_dispatch:  # permet un lancement manuel
    inputs:
      retrain_reason:
        description: "Reason for retraining (new data, new model, drift...)"
        required: false
        default: "manual trigger"

env:
  PYTHON_VERSION: "3.10"
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
  MLFLOW_USERNAME: ${{ secrets.MLFLOW_USERNAME }}
  MLFLOW_PASSWORD: ${{ secrets.MLFLOW_PASSWORD }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  ### ===============================
  ### 1. CODE QUALITY VALIDATION
  ### ===============================
  code_quality:
    name: üß© Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt ruff mypy pytest

      - name: Run linters
        run: |
          echo "üîç Running lint and static checks..."
          ruff check .
          mypy utils/ top_three_models/ runners/

      - name: Run tests
        run: |
          echo "üß™ Running unit tests..."
          pytest -q --disable-warnings --maxfail=1

  ### ===============================
  ### 2. TRAINING AND REGISTRATION
  ### ===============================
  train_and_register:
    name: üöÄ Train & Register Model
    runs-on: ubuntu-latest
    needs: code_quality

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt mlflow boto3

      - name: Run training orchestrator
        run: |
          echo "üèãÔ∏è‚Äç‚ôÇÔ∏è Launching training workflow..."
          python runners/run_top_three_models.py

      - name: Register trained model in MLflow
        run: |
          echo "üì¶ Registering artifacts to MLflow..."
          python utils/mlflow_uploader.py

      - name: Archive trained models
        uses: actions/upload-artifact@v4
        with:
          name: trained-models
          path: |
            storage_models/
            storage_preprocessor/
            reports/

  ### ===============================
  ### 3. OPTIONAL - PREFECT / RETRAIN TRIGGER
  ### ===============================
  trigger_prefect_flow:
    name: ü™∂ Trigger Prefect Retrain Flow
    runs-on: ubuntu-latest
    needs: train_and_register
    # if: ${{ always() && env.PREFECT_API_KEY != '' }}
    steps:
      - name: Call Prefect API (if configured)
        run: |
          curl -X POST "https://api.prefect.cloud/api/deployments/$PREFECT_DEPLOYMENT_ID/run" \
          -H "Authorization: Bearer $PREFECT_API_KEY" \
          -d '{"parameters":{"trigger_source":"GitHub Action"}}'